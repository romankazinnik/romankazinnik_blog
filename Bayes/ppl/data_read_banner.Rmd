---
title: "Prepare Banner data"
# runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Prepare  `banner data`  three variables: `converted`, 
`condition` and `time`. Each website visitor is presented with either `control` and `treatment` condition of website banner, it is also known converted (1/0) and time spent on the website.

Statistics about conversions for control and treatment groups as well as times distributions are illustrated below.

```{r load-packages, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

library(jsonlite)
library(dplyr)
library(lubridate)
library(ggplot2)
library(reshape2)
library(ggpubr)
library(plyr)
#require(RJSONIO) 
library("rwebppl")
```

```{r load data, echo=FALSE}
setwd('~/PycharmProjects/tests/webppl/')
json_file = 'bannerData.json'

# fromJSON(json_file)
dfB <- fromJSON(json_file)
dfB = dfB[, c("condition", "converted", "time")]

dfB$condition = as.factor(dfB$condition)
dfB$convertedFactor = as.factor(dfB$converted)
dfB$convertedNum = as.numeric(dfB$converted)

dfB$timeOriginal = as.numeric( dfB$time )
dfB$time = 4*(-0.45+as.numeric(log(1+dfB$timeOriginal))) # scale to 0-23

levels(dfB$condition) = c("Control", "Treatment")
dfB$timeF = as.factor(as.integer(1.0*dfB$time))

print(str(dfB))
print(summary(dfB))
```

```{r plot data, echo=FALSE}
# ==== 
par(mfrow=c(2,2))
# Control vs Treatment conditions
barplot(table(dfB$condition), main="Condition")
# Converted True vs False 
barplot(table(dfB$convertedFactor), main="Conversions")

M = tapply(dfB$convertedNum, INDEX = dfB$condition, FUN   = mean)
# Converted by condition: same conversions?
boxplot(data = dfB, convertedNum ~ condition, main = " Converted means, by condition ")
points(M, col="red", pch="+", cex=2)

# Converted by time: small times do not convert?
M = tapply(dfB$convertedNum, INDEX = dfB$timeF, FUN   = mean)
boxplot(data = dfB, convertedNum ~ timeF, main = " Converted means, by Time ")
points(M, col="red", pch="+", cex=2)
```

```{r plot data times, echo=FALSE}
par(mfrow=c(1,2))
# Converted by condition: both conditions convert equaly well?
hist(dfB$timeOriginal, breaks=20, main="Time spent on website")
hist(dfB$time, breaks=5, main="Log Time spent on website")
```

```{r plot-conversions-by-time-group, echo=FALSE}
# Those who spend short time - never convert. Others - we need to learn.
dfB_0 <- data.frame( dfB %>% dplyr::group_by(timeF, condition) %>% 
                       dplyr::summarize(mean_converted = mean(convertedNum, na.rm = TRUE)) )
head(dfB_0,2) # print(str(df_by_country))
par(mfrow=c(1,1))
ggbarplot(dfB_0, x = "timeF", y = "mean_converted",
          color = "condition", fill = "condition",
          palette = c("#0073C2FF", "#EFC000FF"),
          label = TRUE, lab.pos = "in", lab.col = "white",
          ggtheme = theme_pubclean()
)
``` 

## Converted: Control-Treatment Condition

**Evrything that we don't know has probbaility.**

The goal is to compare probability of conversion for Control versus Treatment groups. With Bayesian modeling we can learn the **delta** distribution (which is the Control and Treatment distributions difference) and see wether its **95%** confidence interval.

When we ignore the variable **time** we see no evidence of statistical significance for the difference in Control versus Treatment. Continuous (non-categorical) **time** variable can't be utilized directly, except using some naive non-learning approaches such as **rules-based**.

```{r model-data-preparation, echo=FALSE}
df_banner = dfB[, c("time", "condition", "converted")]

df_banner$hour = as.numeric(df_banner$time)
df_banner$converted = as.character(as.numeric(df_banner$converted))
df_banner$group = as.factor(df_banner$condition)
levels(df_banner$group)=c("control", "treatment")

df_banner = df_banner[, c("group", "converted", "hour")]
print(str(df_banner))
summary(df_banner)
```


```{r save-all, echo=FALSE}
save.image("data_banner_snaphot.Rdata")
save(df_banner, file="~/PycharmProjects/tests/webppl/data_banner.Rdata")
```


# Compute current p-values after every observation:
```{r compute-pvalue, echo=FALSE}
pValues <- c()
index <- c()
sample_len = 50
for (i in 50:dim(df_banner)[1]){
  presentData <- table(df_banner$group[1:i], df_banner$converted[1:i])
  ind = sample(0:nrow(df_banner), sample_len, replace=TRUE)
  #presentData <- table(df_banner$group[ind], df_banner$converted[ind])
  
  if (all(rowSums(presentData) > 0)){
    pValues <- c(pValues, prop.test(presentData)$p.value)
    index <- c(index, i)}
}
results <- data.frame(index = index,
                      pValue = pValues)

par(mfrow=c(1,2))
plot(results$pValue, main = "p-value sequence")
hist(results$pValue, breaks = 10, main='p-value distribution')
```